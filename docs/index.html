<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>자동매매 대시보드</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.4rem;
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-mock {
      background: #ffc107;
      color: #333;
    }

    .status-live {
      background: #dc3545;
      color: white;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .card h3 {
      color: #666;
      font-size: 0.75rem;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .card .value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #333;
    }

    .card .value.positive {
      color: #28a745;
    }

    .card .value.negative {
      color: #dc3545;
    }

    .card .sub {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    .section {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section h2 {
      font-size: 1rem;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      font-weight: 600;
      color: #666;
      font-size: 0.75rem;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .text-right {
      text-align: right;
    }

    .profit-positive {
      color: #28a745;
      font-weight: 600;
    }

    .profit-negative {
      color: #dc3545;
      font-weight: 600;
    }

    .trade-buy {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .trade-sell {
      background: #ffebee;
      color: #c62828;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .chart-container {
      height: 250px;
      margin-top: 15px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      flex: 1;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd6;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #888;
    }

    .empty {
      text-align: center;
      padding: 30px;
      color: #888;
    }

    .refresh-time {
      font-size: 0.75rem;
      color: #888;
      text-align: center;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .market-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 10px;
    }

    .market-open {
      background: #28a745;
      color: white;
    }

    .market-closed {
      background: #6c757d;
      color: white;
    }

    .github-link {
      display: inline-block;
      margin-top: 10px;
      color: #667eea;
      text-decoration: none;
      font-size: 0.8rem;
    }

    .github-link:hover {
      text-decoration: underline;
    }

    /* Mobile responsive */
    @media (max-width: 600px) {
      .cards {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .card {
        padding: 12px;
      }

      .card .value {
        font-size: 1.2rem;
      }

      header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      header h1 {
        font-size: 1.2rem;
      }

      table {
        font-size: 0.75rem;
      }

      th, td {
        padding: 8px 4px;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>자동매매 대시보드</h1>
        <span id="marketStatus" class="market-status market-closed">장 마감</span>
      </div>
      <span id="statusBadge" class="status-badge status-mock">모의투자</span>
    </header>

    <div class="actions">
      <button class="btn btn-primary" onclick="refreshAll()">새로고침</button>
      <button class="btn btn-danger" onclick="triggerEmergencySell()">긴급 매도</button>
    </div>

    <div class="cards">
      <div class="card">
        <h3>총 자산</h3>
        <div class="value" id="totalAsset">-</div>
        <div class="sub">예수금 + 평가금액</div>
      </div>
      <div class="card">
        <h3>평가손익</h3>
        <div class="value" id="totalProfit">-</div>
        <div class="sub" id="profitRate">-</div>
      </div>
      <div class="card">
        <h3>예수금</h3>
        <div class="value" id="totalDeposit">-</div>
        <div class="sub">투자 가능</div>
      </div>
      <div class="card">
        <h3>보유 종목</h3>
        <div class="value" id="holdingsCount">-</div>
        <div class="sub">최대 5개</div>
      </div>
    </div>

    <div class="section">
      <h2>보유 종목</h2>
      <div style="overflow-x: auto;">
        <table id="holdingsTable">
          <thead>
            <tr>
              <th>종목</th>
              <th class="text-right">수량</th>
              <th class="text-right">평단가</th>
              <th class="text-right">현재가</th>
              <th class="text-right">수익률</th>
            </tr>
          </thead>
          <tbody id="holdingsBody">
            <tr><td colspan="5" class="loading">로딩 중...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>수익률 추이</h2>
      <div class="chart-container">
        <canvas id="returnsChart"></canvas>
      </div>
    </div>

    <div class="section">
      <h2>최근 매매 기록</h2>
      <div style="overflow-x: auto;">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>시간</th>
              <th>구분</th>
              <th>종목</th>
              <th class="text-right">금액</th>
              <th class="text-right">손익</th>
            </tr>
          </thead>
          <tbody id="tradesBody">
            <tr><td colspan="5" class="loading">로딩 중...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="refresh-time">
      마지막 업데이트: <span id="lastUpdate">-</span><br>
      <a href="https://github.com/dooosp/auto-trader" target="_blank" class="github-link">GitHub 저장소 보기</a>
    </div>
  </div>

  <script>
    // GitHub Raw URL (캐시 방지용 timestamp 추가)
    const GITHUB_BASE = 'https://raw.githubusercontent.com/dooosp/auto-trader/main/data';
    const GITHUB_ACTIONS_URL = 'https://api.github.com/repos/dooosp/auto-trader/actions/workflows/auto-trade.yml/dispatches';

    let returnsChart = null;

    // 숫자 포맷
    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return num.toLocaleString('ko-KR');
    }

    // 금액 포맷 (간략화)
    function formatMoney(num) {
      if (num === null || num === undefined) return '-';
      if (Math.abs(num) >= 100000000) {
        return (num / 100000000).toFixed(1) + '억';
      } else if (Math.abs(num) >= 10000) {
        return (num / 10000).toFixed(0) + '만';
      }
      return num.toLocaleString('ko-KR');
    }

    // 금액 포맷 (전체)
    function formatMoneyFull(num) {
      if (num === null || num === undefined) return '-';
      return num.toLocaleString('ko-KR') + '원';
    }

    // 날짜 포맷
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      const month = (d.getMonth() + 1).toString().padStart(2, '0');
      const day = d.getDate().toString().padStart(2, '0');
      const hour = d.getHours().toString().padStart(2, '0');
      const min = d.getMinutes().toString().padStart(2, '0');
      return `${month}/${day} ${hour}:${min}`;
    }

    // 장 운영시간 체크 (KST 기준)
    function checkMarketStatus() {
      const now = new Date();
      const kst = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC to KST
      const day = kst.getUTCDay();
      const hour = kst.getUTCHours();
      const minute = kst.getUTCMinutes();
      const time = hour * 60 + minute;

      const marketEl = document.getElementById('marketStatus');

      // 평일 9:00 ~ 15:30
      if (day >= 1 && day <= 5 && time >= 540 && time <= 930) {
        marketEl.textContent = '장 운영중';
        marketEl.className = 'market-status market-open';
      } else {
        marketEl.textContent = '장 마감';
        marketEl.className = 'market-status market-closed';
      }
    }

    // GitHub에서 데이터 가져오기
    async function fetchGitHubData(filename) {
      const timestamp = Date.now();
      const url = `${GITHUB_BASE}/${filename}?t=${timestamp}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch');
        return await res.json();
      } catch (error) {
        console.error(`Error fetching ${filename}:`, error);
        return null;
      }
    }

    // 포트폴리오 로드
    async function loadPortfolio() {
      const portfolio = await fetchGitHubData('portfolio.json');

      if (!portfolio) {
        document.getElementById('totalAsset').textContent = '데이터 없음';
        return;
      }

      // summary에서 데이터 추출
      const summary = portfolio.summary || {};
      const totalDeposit = summary.totalDeposit || 0;
      const totalEvaluation = summary.totalEvaluation || 0;
      const totalProfit = summary.totalProfit || 0;

      // 총 자산 계산
      const totalAsset = totalDeposit + totalEvaluation;
      document.getElementById('totalAsset').textContent = formatMoney(totalAsset) + '원';
      document.getElementById('totalDeposit').textContent = formatMoney(totalDeposit) + '원';

      const profitEl = document.getElementById('totalProfit');
      profitEl.textContent = (totalProfit >= 0 ? '+' : '') + formatMoney(totalProfit) + '원';
      profitEl.className = 'value ' + (totalProfit >= 0 ? 'positive' : 'negative');

      // 수익률 계산
      const initialAsset = totalAsset - totalProfit;
      const profitRate = initialAsset > 0 ? (totalProfit / initialAsset * 100) : 0;
      document.getElementById('profitRate').textContent = (profitRate >= 0 ? '+' : '') + profitRate.toFixed(2) + '%';

      // 보유 종목 수
      const holdingsCount = portfolio.holdings?.length || 0;
      document.getElementById('holdingsCount').textContent = holdingsCount + '개';

      // 보유 종목 테이블
      const tbody = document.getElementById('holdingsBody');

      if (!portfolio.holdings || portfolio.holdings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">보유 종목이 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = portfolio.holdings.map(h => {
        const profit = (h.currentPrice - h.avgPrice) * h.quantity;
        const profitRate = ((h.currentPrice - h.avgPrice) / h.avgPrice * 100);
        return `
          <tr>
            <td>${h.name}</td>
            <td class="text-right">${h.quantity}</td>
            <td class="text-right">${formatNumber(h.avgPrice)}</td>
            <td class="text-right">${formatNumber(h.currentPrice || h.avgPrice)}</td>
            <td class="text-right ${profitRate >= 0 ? 'profit-positive' : 'profit-negative'}">
              ${profitRate >= 0 ? '+' : ''}${profitRate.toFixed(1)}%
            </td>
          </tr>
        `;
      }).join('');
    }

    // 매매 기록 로드
    async function loadTrades() {
      const trades = await fetchGitHubData('trades.json');
      const tbody = document.getElementById('tradesBody');

      if (!trades || trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">매매 기록이 없습니다</td></tr>';
        return;
      }

      // 최근 10개만 표시
      const recentTrades = trades.slice(-10).reverse();

      tbody.innerHTML = recentTrades.map(t => `
        <tr>
          <td>${formatDate(t.timestamp)}</td>
          <td><span class="${t.type === 'BUY' ? 'trade-buy' : 'trade-sell'}">${t.type === 'BUY' ? '매수' : '매도'}</span></td>
          <td>${t.name}</td>
          <td class="text-right">${formatMoney(t.price * t.quantity)}</td>
          <td class="text-right ${(t.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative'}">
            ${t.type === 'SELL' ? (t.profit >= 0 ? '+' : '') + formatMoney(t.profit) : '-'}
          </td>
        </tr>
      `).join('');
    }

    // 수익률 차트 로드
    async function loadReturnsChart() {
      const returns = await fetchGitHubData('daily-returns.json');

      if (!returns || returns.length === 0) {
        return;
      }

      const ctx = document.getElementById('returnsChart').getContext('2d');

      // 최근 30일
      const recentReturns = returns.slice(-30);
      const labels = recentReturns.map(r => r.date.slice(5)); // MM-DD
      const profits = recentReturns.map(r => r.totalProfit || 0);

      if (returnsChart) {
        returnsChart.destroy();
      }

      // 색상 결정
      const lastProfit = profits[profits.length - 1] || 0;
      const color = lastProfit >= 0 ? '#28a745' : '#dc3545';

      returnsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '평가손익',
            data: profits,
            borderColor: color,
            backgroundColor: lastProfit >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            }
          },
          scales: {
            y: {
              ticks: {
                callback: value => formatMoney(value)
              }
            },
            x: {
              ticks: {
                maxTicksLimit: 7
              }
            }
          }
        }
      });
    }

    // 긴급 매도 (GitHub Actions 트리거)
    async function triggerEmergencySell() {
      if (!confirm('정말로 모든 보유 종목을 긴급 매도하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
        return;
      }

      // GitHub Personal Access Token 필요
      const token = prompt('GitHub Personal Access Token을 입력하세요:\n(repo 권한 필요)');

      if (!token) {
        alert('토큰이 필요합니다.');
        return;
      }

      try {
        const res = await fetch(GITHUB_ACTIONS_URL, {
          method: 'POST',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ref: 'main',
            inputs: {
              job_type: 'emergency'
            }
          })
        });

        if (res.status === 204) {
          alert('긴급 매도가 시작되었습니다.\n\nGitHub Actions에서 실행 상태를 확인하세요.');
        } else {
          const error = await res.json();
          alert('실패: ' + (error.message || '알 수 없는 오류'));
        }
      } catch (error) {
        alert('오류: ' + error.message);
      }
    }

    // 전체 새로고침
    async function refreshAll() {
      checkMarketStatus();

      await Promise.all([
        loadPortfolio(),
        loadTrades(),
        loadReturnsChart(),
      ]);

      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ko-KR');
    }

    // 초기 로드
    refreshAll();

    // 1분마다 자동 새로고침
    setInterval(refreshAll, 60000);

    // 장 상태 10초마다 체크
    setInterval(checkMarketStatus, 10000);
  </script>
</body>
</html>
